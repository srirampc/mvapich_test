#include <numeric>
#include <tuple>
#include <vector>
#include <limits>
#include <iostream>
#include <cassert>
#include <mpi.h>

int MESSAGE_SIZES[32] = { 62810, 92785, 101355, 102780, 62810, 57100, 68520, 51390,
                        34260, 57100, 68520, 79940, 91360, 45680, 70660, 112059,
                        102780, 45680, 79940, 74230, 91360, 78515, 58526, 45680,
                        68520, 97070, 124911, 74940, 97070, 114200, 74230, 62810 };

int OUTPUT_SIZES[32] = { 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550,
                        76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550,
                        76550, 76550, 76550, 76550, 76550, 76550, 76550, 76549,
                        76549, 76549, 76549, 76549, 76549, 76549, 76549, 76549 };

// All2AllV Counts:
//   for each rank : 0 - 31
//      - send counts, send displs, recv counts, recv displ.
int const A2AV_ARGS[128][32] = {
    // Rank 0 
    { 62810, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810 },
    { 62810, 13740, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 62810, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550 },
    // Rank 1 
    { 13740, 76550, 2495, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 13740, 90290, 92785, 92785, 92785, 92785, 92785, 92785, 92785, 92785, 92785, 92785, 92785, 92785, 92785, 92785, 92785, 92785, 92785, 92785, 92785, 92785, 92785, 92785, 92785, 92785, 92785, 92785, 92785, 92785, 92785 },
    { 0, 76550, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550 },
    // Rank 2 
    { 0, 0, 74055, 27300, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 74055, 101355, 101355, 101355, 101355, 101355, 101355, 101355, 101355, 101355, 101355, 101355, 101355, 101355, 101355, 101355, 101355, 101355, 101355, 101355, 101355, 101355, 101355, 101355, 101355, 101355, 101355, 101355, 101355 },
    { 0, 2495, 74055, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 2495, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550 },
    // Rank 3
    { 0, 0, 0, 49250, 53530, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 49250, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780 },
    { 0, 0, 27300, 49250, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 27300, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550 },
    // Rank 4 
    { 0, 0, 0, 0, 23020, 39790, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 23020, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810, 62810 },
    { 0, 0, 0, 53530, 23020, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 53530, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550 },
    // Rank 5
    { 0, 0, 0, 0, 0, 36760, 20340, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 36760, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100 },
    { 0, 0, 0, 0, 39790, 36760, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 39790, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550 },
    // Rank 6 
    { 0, 0, 0, 0, 0, 0, 56210, 12310, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 56210, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520 },
    { 0, 0, 0, 0, 0, 20340, 56210, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 20340, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550 },
    // Rank 7
    { 0, 0, 0, 0, 0, 0, 0, 51390, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 51390, 51390, 51390, 51390, 51390, 51390, 51390, 51390, 51390, 51390, 51390, 51390, 51390, 51390, 51390, 51390, 51390, 51390, 51390, 51390, 51390, 51390, 51390, 51390 },
    { 0, 0, 0, 0, 0, 0, 12310, 51390, 12850, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 12310, 63700, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550 },
    // Rank 8 
    { 0, 0, 0, 0, 0, 0, 0, 12850, 21410, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 12850, 34260, 34260, 34260, 34260, 34260, 34260, 34260, 34260, 34260, 34260, 34260, 34260, 34260, 34260, 34260, 34260, 34260, 34260, 34260, 34260, 34260, 34260, 34260 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 21410, 55140, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 21410, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550 },
    // Rank 9 
    { 0, 0, 0, 0, 0, 0, 0, 0, 55140, 1960, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 55140, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100, 57100 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 1960, 68520, 6070, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1960, 70480, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550 },
    // Rank 10
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 68520, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 73870, 2680, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 73870, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550 },
    // Rank 11
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 6070, 73870, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6070, 79940, 79940, 79940, 79940, 79940, 79940, 79940, 79940, 79940, 79940, 79940, 79940, 79940, 79940, 79940, 79940, 79940, 79940, 79940, 79940, 79940 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 76550, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550 },
    // Rank 12
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2680, 76550, 12130, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2680, 79230, 91360, 91360, 91360, 91360, 91360, 91360, 91360, 91360, 91360, 91360, 91360, 91360, 91360, 91360, 91360, 91360, 91360, 91360, 91360 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12130, 45680, 18740, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12130, 57810, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550 },
    // Rank 13
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 45680, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 45680, 45680, 45680, 45680, 45680, 45680, 45680, 45680, 45680, 45680, 45680, 45680, 45680, 45680, 45680, 45680, 45680, 45680, 45680 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 51920, 24630, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 51920, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550 },
    // Rank 14
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 18740, 51920, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 18740, 70660, 70660, 70660, 70660, 70660, 70660, 70660, 70660, 70660, 70660, 70660, 70660, 70660, 70660, 70660, 70660, 70660, 70660 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 76550, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550 },
    // Rank 15
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 24630, 76550, 10879, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 24630, 101180, 112059, 112059, 112059, 112059, 112059, 112059, 112059, 112059, 112059, 112059, 112059, 112059, 112059, 112059, 112059, 112059 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10879, 65671, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10879, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550 },
    // Rank 16
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 65671, 37109, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 65671, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780, 102780 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 37109, 39441, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 37109, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550 },
    // Rank 17
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 39441, 6239, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 39441, 45680, 45680, 45680, 45680, 45680, 45680, 45680, 45680, 45680, 45680, 45680, 45680, 45680, 45680 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6239, 70311, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6239, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550 },
    // Rank 18
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 70311, 9629, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 70311, 79940, 79940, 79940, 79940, 79940, 79940, 79940, 79940, 79940, 79940, 79940, 79940, 79940 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9629, 66921, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9629, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550 },
    // Rank 19
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 66921, 7309, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 66921, 74230, 74230, 74230, 74230, 74230, 74230, 74230, 74230, 74230, 74230, 74230, 74230 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7309, 69241, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7309, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550 },
    // Rank 20
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 69241, 22119, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 69241, 91360, 91360, 91360, 91360, 91360, 91360, 91360, 91360, 91360, 91360, 91360 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 22119, 54431, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 22119, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550 },
    // Rank 21
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 54431, 24084, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 54431, 78515, 78515, 78515, 78515, 78515, 78515, 78515, 78515, 78515, 78515 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 24084, 52466, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 24084, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550, 76550 },
    // Rank 22
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 52466, 6060, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 52466, 58526, 58526, 58526, 58526, 58526, 58526, 58526, 58526, 58526 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6060, 45680, 24810, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6060, 51740, 76550, 76550, 76550, 76550, 76550, 76550, 76550 },
    // Rank 23
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 45680, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 45680, 45680, 45680, 45680, 45680, 45680, 45680, 45680, 45680 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 43710, 32839, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 43710, 76549, 76549, 76549, 76549, 76549, 76549 },
    // Rank 24
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 24810, 43710, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 24810, 68520, 68520, 68520, 68520, 68520, 68520, 68520, 68520 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64231, 12318, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64231, 76549, 76549, 76549, 76549, 76549 },
    // Rank 25
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 32839, 64231, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 32839, 97070, 97070, 97070, 97070, 97070, 97070, 97070 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 76549, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 76549, 76549, 76549, 76549, 76549 },
    // Rank 26
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12318, 76549, 36044, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12318, 88867, 124911, 124911, 124911, 124911, 124911 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 36044, 40505, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 36044, 76549, 76549, 76549, 76549 },
    // Rank 27
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 40505, 34435, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 40505, 74940, 74940, 74940, 74940 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 34435, 42114, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 34435, 76549, 76549, 76549 },
    // Rank 28
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 42114, 54956, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 42114, 97070, 97070, 97070 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 54956, 21593, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 54956, 76549, 76549 },
    //Rank 29
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21593, 76549, 16058, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21593, 98142, 114200 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 76549, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 76549, 76549 },
    // Rank 30
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 60491, 13739 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 60491 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16058, 60491, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16058, 76549 },
    // Rank 31
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 62810 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 13739, 62810 },
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 13739 }
};

void myMPIErrorHandler(MPI_Comm*, int* ...) {
  // throw exception, enables gdb stack trace analysis
  throw std::runtime_error("MPI Error");
}

using TestType = std::pair<double, float>;

MPI_Datatype pair_mpi_datatype() {
  MPI_Datatype _type;

  int blocklen[2] = {1, 1};
  MPI_Aint displs[2] = {0,0};
  // get actual displacement (in case of padding in the structure)
  TestType p;
  MPI_Aint p_adr, t1_adr, t2_adr;
  MPI_Get_address(&p, &p_adr);
  MPI_Get_address(&p.first, &t1_adr);
  MPI_Get_address(&p.second, &t2_adr);
  displs[0] = t1_adr - p_adr;
  displs[1] = t2_adr - p_adr;

  MPI_Datatype types[2] = {MPI_DOUBLE, MPI_FLOAT};
  // in case elements are represented the opposite way around in
  // the pair (gcc does so), then swap them
  if (displs[0] > displs[1]) {
      std::swap(displs[0], displs[1]);
      std::swap(types[0], types[1]);
  }
  // create MPI_Datatype (resized to actual sizeof())
  MPI_Datatype struct_type;
  MPI_Type_create_struct(2, blocklen, displs, types, &struct_type);
  MPI_Type_create_resized(struct_type, 0, sizeof(p), &_type);
  MPI_Type_commit(&_type);
  MPI_Type_free(&struct_type);
  return _type;
}


template<typename Iterator>
int check_displacements(Iterator begin, Iterator end, Iterator check) {
    int nfailed = 0;
    int tmp = 0, sum = 0;
    while (begin != end) {
        tmp = sum;
        sum += *begin;
        if(*check != tmp) nfailed += 1;
        ++begin;
        ++check;
    }
    return nfailed;
}

int check_send_recv_tally(int rank, int size, const int* recv_counts){
    int nfailed = 0;
    for(int i = 0; i < size; i++) {
        if(A2AV_ARGS[i*4][rank] != recv_counts[i])
            nfailed += 1;
    }
    return nfailed;
}

int sanity_check_all2allv_args(int size, bool print_err){
    int failed_counts = 0;
    for(int rank = 0; rank < size; rank++){
        int rank_idx = rank * 4;
        const int* send_counts = A2AV_ARGS[rank_idx];
        const int* send_displs = A2AV_ARGS[rank_idx + 1];
        const int* recv_counts = A2AV_ARGS[rank_idx + 2];
        const int* recv_displs = A2AV_ARGS[rank_idx + 3];
        // Sanity Check
        //   Send and Recv should tally
        int nfailed = check_send_recv_tally(rank, size, recv_counts);
        //   Check if Displacements are prefix summed
        nfailed += check_displacements(send_counts, send_counts + size, 
                                            send_displs);
        nfailed += check_displacements(recv_counts, recv_counts + size, 
                                            recv_displs);
        if(print_err && nfailed > 0) {
            std::cerr << nfailed << " sanity checks failed at rank : "
                      << rank  << std::endl;
        }
        failed_counts += nfailed;
    }
    if(print_err && failed_counts > 0) {
        std::cerr << "Total Failed : " << failed_counts << std::endl;
    }
    return failed_counts;
}

int mva2av_test2(int argc, char** argv,
                MPI_Comm comm, int rank, int size) {
    std::vector<TestType> msg(MESSAGE_SIZES[rank]);
    std::vector<TestType> out(OUTPUT_SIZES[rank]);

    int rank_idx = rank * 4;
    const int* send_counts = A2AV_ARGS[rank_idx];
    const int* send_displs = A2AV_ARGS[rank_idx + 1];
    const int* recv_counts = A2AV_ARGS[rank_idx + 2];
    const int* recv_displs = A2AV_ARGS[rank_idx + 3];

    if (rank == 0){
       std::cout << "Start All2All" << std::endl;
    }
    MPI_Datatype pair_dt = pair_mpi_datatype();
    int rx = MPI_Alltoallv(const_cast<TestType*>(&msg[0]),
                  &send_counts[0], &send_displs[0], pair_dt,
                  &out[0], &recv_counts[0], &recv_displs[0], pair_dt, comm);
    if (rank == 0){
       std::cout << "Finish All2All w. R code : " << rx << std::endl;
    }
    return rx;
}

int main(int argc, char** argv) {
    MPI_Init(&argc, &argv);

    // Get the number of processes
    int rank, size;
    MPI_Comm_size(MPI_COMM_WORLD, &size);
    MPI_Comm_rank(MPI_COMM_WORLD, &rank);

    if (size == (int) sizeof(MESSAGE_SIZES)) {
        int total_failed = sanity_check_all2allv_args(size, rank == 0);
        if (total_failed > 0){
            return 0;
        }
        mva2av_test2(argc, argv, MPI_COMM_WORLD, rank, size);
    } else {
        std::cout << "Size should be 32 : 2 nodes with 16 process each"
                  << std::endl;
    }

    return MPI_Finalize();
}

